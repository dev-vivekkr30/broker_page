{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Colonies/Area{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="{% static 'css/admin/designSystem.css' %}">
<link rel="stylesheet" href="{% static 'css/admin/alertsmsg.css' %}">
<link rel="stylesheet" href="{% static 'css/admin/menu.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="d-flex justify-content-start">
        {% include 'admin/includes/sidebar.html' %}
        <div class="w-100">
            {% include 'admin/includes/topbar.html' %}

            <!-- Messages -->
            {% if messages %}
            <div class="mt-3">
                {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="dataOverviewSection mt-3">
                <div class="section-title">
                    <h6 class="fw-bold m-0">All Colonies/Area <span class="fw-normal text-muted">({{ colonies.count }})</span></h6>
                    <div class="d-flex align-items-center">
                        <a class="dropdown-item small me-2" href="{% url 'custom_admin:download_colonies_template' %}"><i class="bi bi-file-earmark-arrow-down"></i>
                            Download Template</a>
                        <a class="secondary-btn me-2 addBtn" href="#" data-bs-toggle="modal"
                            data-bs-target="#importModal"><i class="bi bi-cloud-arrow-up me-2"></i> Import</a>
                        <a class="secondary-btn me-2 addBtn" href="{% url 'custom_admin:export_colonies' %}"><i class="bi bi-cloud-arrow-down me-2"></i>
                            Export</a>
                        <a href="#" class="primary-btn addBtn w-100" data-bs-toggle="modal"
                            data-bs-target="#addColonyModal">+
                            Add
                            Colony/Area</a>
                    </div>
                </div>
                
                <!-- Add Colony Modal Start -->
                <div class="modal fade" id="addColonyModal" tabindex="-1" aria-labelledby="addColonyModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="addColonyModalLabel">Add Colony/Area</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <form method="post" action="{% url 'custom_admin:add_colony' %}">
                                {% csrf_token %}
                                <div class="modal-body">
                                    <div class="mb-1 w-100">
                                        <label for="colony_name" class="form-label mb-1">Colony/Area Name</label>
                                        <input type="text" class="form-control w-100" id="colony_name" name="colony_name" required>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="secondary-btn addBtn"
                                        data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="primary-btn addBtn">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- Add Colony Modal End -->

                <!-- Edit Colony Modal Start -->
                <div class="modal fade" id="editColonyModal" tabindex="-1" aria-labelledby="editColonyModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="editColonyModalLabel">Edit Colony/Area</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <form method="post" id="editColonyForm">
                                {% csrf_token %}
                                <div class="modal-body">
                                    <div class="mb-1 w-100">
                                        <label for="edit_colony_name" class="form-label mb-1">Colony/Area Name</label>
                                        <input type="text" class="form-control w-100" id="edit_colony_name" name="colony_name" required>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="secondary-btn addBtn"
                                        data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="primary-btn addBtn">Update</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- Edit Colony Modal End -->

                <div class="dataOverview mt-3">
                    <div class="table-responsive">
                        <table class="table" id="projectsTable">
                            <thead>
                                <tr>
                                    <th style="border-top-left-radius: 6px; border-bottom-left-radius: 6px;"
                                        scope="col">S/N</th>
                                    <th scope="col">Colonies/Area</th>
                                    <th style="border-top-right-radius: 6px; border-bottom-right-radius: 6px;"
                                        scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for colony in colonies %}
                                <tr>
                                    <td>{{ forloop.counter|stringformat:"02d" }}</td>
                                    <td>{{ colony.name }}</td>
                                    <td>
                                        <div class="dropdown">
                                            <i class="bi bi-three-dots-vertical" type="button"
                                                data-bs-toggle="dropdown" aria-expanded="false"></i>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item small" href="#" data-bs-toggle="modal"
                                                        data-bs-target="#editColonyModal" 
                                                        data-colony-id="{{ colony.id }}"
                                                        data-colony-name="{{ colony.name }}">Edit</a></li>
                                                <li><a class="dropdown-item small" href="#" data-bs-toggle="modal"
                                                        data-bs-target="#deleteModal" 
                                                        data-colony-id="{{ colony.id }}"
                                                        data-colony-name="{{ colony.name }}">Delete</a></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center">No colonies/areas found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% include 'admin/includes/footer.html' %}
</div>

<!-- Delete Modal Start -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <p>Are you sure you want to delete <span id="colony-name-display"></span>?</p>
                <form method="post" action="{% url 'custom_admin:delete_colony' %}" id="delete-form">
                    {% csrf_token %}
                    <input type="hidden" name="colony_id" id="colony-id-input">
                    <div class="d-flex justify-content-end">
                        <button type="button" class="secondary-btn me-2 addBtn" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="primary-btn addBtn">Yes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Delete Modal End -->

<!-- Import Modal Start -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'custom_admin:import_colonies' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="upload-container">
                        <div class="upload-icon">
                            <i class="bi bi-cloud-upload"></i>
                        </div>

                        <label for="file-input" class="btn-upload">
                            + Select files
                        </label>
                        <input type="file" id="file-input" name="colonies_file" accept=".xls,.xlsx,.csv" required>

                        <p class="mt-4 mb-1 fw-bold">
                            Add <span class="fw-bold">Google Sheets</span>, <span class="fw-bold">Excel</span> files
                        </p>
                        <div class="d-flex flex-wrap justify-content-center mt-2">
                            <span class="badge bg-danger text-white format-badge">XLS</span>
                            <span class="badge bg-danger text-white format-badge">CSV</span>
                        </div>

                        <!-- File name display area -->
                        <div id="file-names" class="mt-3 text-center small"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary-btn" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="primary-btn">Import</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Import Modal End -->
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="{% static 'js/datatable.js' %}"></script>
<script src="{% static 'js/admin/sidebar.js' %}"></script>
<script src="{% static 'js/admin/menu.js' %}"></script>
<script src="{% static 'js/admin/user.js' %}"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<script>
$(document).ready(function() {
    // Handle delete modal
    $('#deleteModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var colonyId = button.data('colony-id');
        var colonyName = button.data('colony-name');
        
        $('#colony-id-input').val(colonyId);
        $('#colony-name-display').text(colonyName);
    });
    
    // Handle edit modal
    $('#editColonyModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var colonyId = button.data('colony-id');
        var colonyName = button.data('colony-name');
        
        $('#edit_colony_name').val(colonyName);
        $('#editColonyForm').attr('action', '{% url "custom_admin:edit_colony" 0 %}'.replace('0', colonyId));
    });
    
    // Handle file input display
    $('#file-input').change(function() {
        var fileName = $(this).val().split('\\').pop();
        $('#file-names').html('<p>Selected file: ' + fileName + '</p>');
    });
    
    // Initialize DataTable
    if ( $.fn.DataTable.isDataTable('#projectsTable') ) {
        $('#projectsTable').DataTable().destroy();
    }
    $('#projectsTable').DataTable({
        "pageLength": 10,
        "order": [[0, "asc"]],
        "language": {
            "search": "Search colonies:",
            "lengthMenu": "Show _MENU_ colonies per page",
            "info": "Showing _START_ to _END_ of _TOTAL_ colonies"
        }
    });
    
    // Auto-hide alerts after 5 seconds
    setTimeout(function() {
        $('.alert').fadeOut('slow');
    }, 5000);
});
</script>
{% endblock %}