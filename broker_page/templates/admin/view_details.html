{% load static %}
{% load broker_filters %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broker Details | Broker.Page Admin</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- Fancybox Links -->
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css" />

    <link rel="stylesheet" href="{% static 'css/admin/menu.css' %}">
    <link rel="stylesheet" href="{% static 'css/admin/dashboard.css' %}">

</head>

<body>
    <div class="container-fluid p-0">
        <div class="d-flex justify-content-start">
            <custom-sidebar></custom-sidebar>
            <div class="w-100">
                <div class="topBar">
                    <div class="topbarLeft">
                        <h6 class="m-0 fw-bold">Welcome, {{ admin_user.full_name|default:"Admin" }}</h6>
                        <p class="m-0 small">Today is {{ current_date }}.</p>
                    </div>
                    <div class="topbarRight">
                        <div class="dropdown">
                            <div class="d-flex align-items-center justify-content-center" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <div class="d-flex align-items-center justify-content-start">
                                    <i class="bi bi-person-circle me-2" style="font-size: 32px; line-height: 0;"></i>
                                    <div>
                                        <p class="m-0 fw-bold" style="line-height: normal;">{{ admin_user.full_name|default:"Admin" }}</p>
                                        <p class="m-0 small" style="line-height: normal;">Administrator</p>
                                    </div>
                                </div>
                                <i class="bi bi-chevron-down ms-3"></i>
                            </div>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{% url 'custom_admin:admin_logout' %}"><i
                                            class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>


                <div class="dataOverviewSection mt-3">
                    <div class="dataOverview mt-3">
                        <a href="{% url 'custom_admin:admin_dashboard' %}" class="backBtn mb-3"> <i class="bi bi-arrow-left me-2"></i>Back</a>
                        <div class="table-responsive">
                            <p class="mb-2 fw-bold text-danger w-100 pb-1 border-bottom border-muted">Broker Details</p>
                            <form method="post" action="#">
                                {% csrf_token %}
                                <table class="table table-borderless">
                                    <tbody>
                                        <tr>
                                            <th>Broker's Name</th>
                                            <td><input type="text" class="form-control w-100" name="full_name" placeholder="Enter Name" value="{{ broker.full_name }}" disabled></td>
                                            <td style="float: right !important;">
                                                <div class="toggle-switch {% if broker.is_name_verified %}approved{% else %}rejected{% endif %}" 
                                                     data-field="is_name_verified" 
                                                     data-broker-id="{{ broker.id }}">
                                                    <span class="toggle-label">{% if broker.is_name_verified %}Verified{% else %}Not Verified{% endif %}</span>
                                                    <div class="toggle-thumb"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Broker's Profile Photo</th>
                                            <td>
                                                <div class="d-flex gap-2 align-items-start">
                                                    <a data-fancybox="gallery" class="user-image position-relative" href="{% if broker.profile_photo %}{{ broker.profile_photo.url }}{% else %}{% static 'images/admin/userDefaultimage.svg' %}{% endif %}">
                                                        <div class="overlay">
                                                            <i class="bi bi-zoom-in"></i>
                                                        </div>
                                                        <img class="w-100 profilePic" src="{% if broker.profile_photo %}{{ broker.profile_photo.url }}{% else %}{% static 'images/admin/userDefaultimage.svg' %}{% endif %}"
                                                            alt="" style="border-radius:6px;" />
                                                    </a>
                                                </div>
                                            </td>
                                            <td style="float: right !important;">
                                                <div class="toggle-switch {% if broker.is_photo_verified %}approved{% else %}rejected{% endif %}" 
                                                     data-field="is_photo_verified" 
                                                     data-broker-id="{{ broker.id }}">
                                                    <span class="toggle-label">{% if broker.is_photo_verified %}Verified{% else %}Not Verified{% endif %}</span>
                                                    <div class="toggle-thumb"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Company Name</th>
                                            <td><input type="text" class="form-control w-100" name="company" placeholder="Enter Company Name" value="{{ broker.company }}" disabled></td>
                                            <td style="float: right !important;">
                                                <div class="toggle-switch {% if broker.is_company_verified %}approved{% else %}rejected{% endif %}" 
                                                     data-field="is_company_verified" 
                                                     data-broker-id="{{ broker.id }}">
                                                    <span class="toggle-label">{% if broker.is_company_verified %}Verified{% else %}Not Verified{% endif %}</span>
                                                    <div class="toggle-thumb"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Age</th>
                                            <td><input type="number" class="form-control w-100" name="age" placeholder="Enter Age" value="{{ broker.age }}" disabled></td>
                                            <td style="float: right !important;">
                                                <div class="toggle-switch {% if broker.is_age_verified %}approved{% else %}rejected{% endif %}" 
                                                     data-field="is_age_verified" 
                                                     data-broker-id="{{ broker.id }}">
                                                    <span class="toggle-label">{% if broker.is_age_verified %}Verified{% else %}Not Verified{% endif %}</span>
                                                    <div class="toggle-thumb"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Education</th>
                                            <td><input type="text" class="form-control w-100" name="education" placeholder="Enter Education" value="{{ broker.education }}" disabled></td>
                                            <td style="float: right !important;">
                                                <div class="toggle-switch {% if broker.is_education_verified %}approved{% else %}rejected{% endif %}" 
                                                     data-field="is_education_verified" 
                                                     data-broker-id="{{ broker.id }}">
                                                    <span class="toggle-label">{% if broker.is_education_verified %}Verified{% else %}Not Verified{% endif %}</span>
                                                    <div class="toggle-thumb"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Residence Colony</th>
                                            <td><input type="text" class="form-control w-100" name="residence_colony" placeholder="Enter Residence Colony" value="{{ broker.residence_colony }}" disabled></td>
                                            <td style="float: right !important;">
                                                <div class="toggle-switch {% if broker.is_residence_colony_verified %}approved{% else %}rejected{% endif %}" 
                                                     data-field="is_residence_colony_verified" 
                                                     data-broker-id="{{ broker.id }}">
                                                    <span class="toggle-label">{% if broker.is_residence_colony_verified %}Verified{% else %}Not Verified{% endif %}</span>
                                                    <div class="toggle-thumb"></div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Office Address</th>
                                            <td><textarea name="office_address" class="textarea-control" disabled>{{ broker.office_address }}</textarea></td>
                                            <td style="float: right !important;">
                                                <div class="toggle-switch {% if broker.is_office_address_verified %}approved{% else %}rejected{% endif %}" 
                                                     data-field="is_office_address_verified" 
                                                     data-broker-id="{{ broker.id }}">
                                                    <span class="toggle-label">{% if broker.is_office_address_verified %}Verified{% else %}Not Verified{% endif %}</span>
                                                    <div class="toggle-thumb"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </form>
                        </div>
                    </div>
                    <div class="dataOverview mt-3 mb-3">
                        <div class="table-responsive">
                            <p class="mb-2 fw-bold text-danger w-100 pb-1 border-bottom border-muted">Other Details</p>
                            <form>
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <th style="width: 34%; vertical-align: top;">About Me</th>
                                        <td><textarea name="about" class="textarea-control" disabled>{{ broker.about }}</textarea></td>
                                    </tr>
                                    <tr>
                                        <th>Mobile Number</th>
                                        <td><input type="text" class="form-control" name="mobile" placeholder="Mobile Number" value="{{ broker.mobile }}" disabled></td>
                                    </tr>
                                    <tr>
                                        <th>WhatsApp Number</th>
                                        <td><input type="text" class="form-control w-100" name="whatsapp" placeholder="WhatsApp Number" value="{{ broker.whatsapp }}" disabled></td>
                                    </tr>
                                    <tr>
                                        <th class="w-25">Email Id</th>
                                        <td><input type="email" name="email" class="form-control w-100 me-2" placeholder="Email" value="{{ broker.email }}" disabled></td>
                                    </tr>
                                    <tr>
                                        <th class="w-25">Google Map URL</th>
                                        <td><textarea name="google_maps_url" class="textarea-control" id="googleMapUrl" placeholder="Google Map URL" disabled>{{ broker.google_maps_url }}</textarea></td>
                                    </tr>
                                    <tr>
                                        <th>Expertise</th>
                                        <td><input type="text" class="form-control w-100" name="expertise" placeholder="Enter Expertise" value="{{ broker.expertise }}" disabled></td>
                                    </tr>
                                    <tr>
                                        <th>Achievements</th>
                                        <td><textarea name="achievements" class="textarea-control" placeholder="Enter Achievements" disabled>{{ broker.achievements }}</textarea></td>
                                    </tr>
                                    <tr>
                                        <th>Listings</th>
                                        <td><textarea name="listings" class="textarea-control" placeholder="Enter Listings" disabled>{{ broker.listings }}</textarea></td>
                                    </tr>
                                    <tr>
                                        <th>Min Deal Size</th>
                                        <td><input type="text" class="form-control w-100" name="min_deal_size" placeholder="Enter Min Deal Size" value="{{ broker.min_deal_size }}" disabled></td>
                                    </tr>
                                    <tr>
                                        <th>Max Deal Size</th>
                                        <td><input type="text" class="form-control w-100" name="max_deal_size" placeholder="Enter Max Deal Size" value="{{ broker.max_deal_size }}" disabled></td>
                                    </tr>
                                    <tr>
                                        <th>Social Media Links</th>
                                        <td>
                                            <div class="row">
                                                <div class="col-md-6 mb-2">
                                                    <input type="url" class="form-control" name="facebook_url" placeholder="Facebook URL" value="{{ broker.facebook_url }}" disabled>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <input type="url" class="form-control" name="linkedin_url" placeholder="LinkedIn URL" value="{{ broker.linkedin_url }}" disabled>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <input type="url" class="form-control" name="instagram_url" placeholder="Instagram URL" value="{{ broker.instagram_url }}" disabled>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <input type="url" class="form-control" name="twitter_url" placeholder="Twitter URL" value="{{ broker.twitter_url }}" disabled>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <input type="url" class="form-control" name="youtube_url" placeholder="YouTube URL" value="{{ broker.youtube_url }}" disabled>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <input type="url" class="form-control" name="website" placeholder="Website URL" value="{{ broker.website }}" disabled>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            </form>
                        </div>
                    </div>
                    
                    <!-- <div class="d-flex justify-content-end gap-2 mb-3">
                        {% if broker.is_paid %}
                        <a href="#" class="btn btn-success">Download Invoice</a>
                        {% endif %}
                    </div> -->
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js"
        integrity="sha512-+k1pnlgt4F1H8L7t3z95o3/KO+o78INEcXTbnoJQ/F2VqDVhWoaiVml/OEHv9HsVgxUaVW+IbiZPUJQfF/YxZw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script src="{% static 'js/admin/sidebar.js' %}"></script>
    <script src="{% static 'js/admin/user.js' %}"></script>
    <script src="{% static 'js/admin/menu.js' %}"></script>
    <script src="{% static 'js/admin/viewDetails.js' %}"></script>
    
    <script>
        // Handle verification toggle switches
        document.addEventListener('DOMContentLoaded', function() {
            const toggleSwitches = document.querySelectorAll('.toggle-switch');
            
            toggleSwitches.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const field = this.getAttribute('data-field');
                    const brokerId = this.getAttribute('data-broker-id');
                    const isCurrentlyVerified = this.classList.contains('approved');
                    const newValue = !isCurrentlyVerified;
                    
                    // Show loading state
                    this.style.pointerEvents = 'none';
                    const originalLabel = this.querySelector('.toggle-label').textContent;
                    this.querySelector('.toggle-label').textContent = 'Updating...';
                    
                    // Make AJAX call to update verification status
                    fetch(`/admin/user/${brokerId}/toggle_verification/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: `field=${field}&value=${newValue}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update toggle switch appearance
                            if (newValue) {
                                this.classList.remove('rejected');
                                this.classList.add('approved');
                                this.querySelector('.toggle-label').textContent = 'Verified';
                            } else {
                                this.classList.remove('approved');
                                this.classList.add('rejected');
                                this.querySelector('.toggle-label').textContent = 'Not Verified';
                            }
                            
                            // Update verification summary if it exists
                            updateVerificationSummary();
                            
                            // Show success message
                            showNotification('Verification status updated successfully!', 'success');
                        } else {
                            // Revert on error
                            this.querySelector('.toggle-label').textContent = originalLabel;
                            showNotification('Failed to update verification status.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        this.querySelector('.toggle-label').textContent = originalLabel;
                        showNotification('An error occurred while updating verification status.', 'error');
                    })
                    .finally(() => {
                        this.style.pointerEvents = 'auto';
                    });
                });
            });
            
            function updateVerificationSummary() {
                // Reload the page to update the verification summary
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
            
            function showNotification(message, type) {
                // Create a simple notification
                const notification = document.createElement('div');
                notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                // Remove notification after 3 seconds
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        });
    </script>
</body>

</html>